#!/bin/bash
# Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ POS Ð½Ð° VPS Ñ Docker
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: bash deploy-docker.sh

set -e

echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ POS ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
echo ""

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}âŒ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root (sudo)${NC}"
    exit 1
fi

echo -e "${GREEN}1/7${NC} ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
apt update && apt upgrade -y

echo -e "${GREEN}2/7${NC} Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker..."
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
    echo "âœ… Docker ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
else
    echo "âœ… Docker ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

echo -e "${GREEN}3/7${NC} Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose..."
if ! command -v docker-compose &> /dev/null; then
    apt install docker-compose -y
    echo "âœ… Docker Compose ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
else
    echo "âœ… Docker Compose ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

echo -e "${GREEN}4/7${NC} ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
if netstat -tuln | grep -q ":8080 "; then
    echo -e "${YELLOW}âš ï¸  ÐŸÐ¾Ñ€Ñ‚ 8080 Ð·Ð°Ð½ÑÑ‚. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼...${NC}"
    fuser -k 8080/tcp || true
fi

echo -e "${GREEN}5/7${NC} Ð—Ð°Ð¿ÑƒÑÐº Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
cd "$(dirname "$0")"
docker-compose down 2>/dev/null || true
docker-compose up -d --build

echo -e "${GREEN}6/7${NC} ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°..."
sleep 5
docker-compose ps

echo ""
echo -e "${GREEN}7/7${NC} ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)..."
read -p "Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Nginx Ð´Ð»Ñ SSL? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    apt install nginx -y
    
    cat > /etc/nginx/sites-available/pos << 'NGINX_CONFIG'
server {
    listen 80;
    server_name pos.kruhn.eu;

    client_max_body_size 50M;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
NGINX_CONFIG

    ln -sf /etc/nginx/sites-available/pos /etc/nginx/sites-enabled/
    rm -f /etc/nginx/sites-enabled/default
    nginx -t && systemctl reload nginx
    
    echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚? (y/n): "
    read -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        apt install certbot python3-certbot-nginx -y
        certbot --nginx -d pos.kruhn.eu --non-interactive --agree-tos --email admin@kruhn.eu
    fi
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${GREEN}âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²:"
docker-compose ps
echo ""
echo "ðŸŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑŽ:"
if [ -f /etc/nginx/sites-enabled/pos ]; then
    echo "   https://pos.kruhn.eu (Ñ‡ÐµÑ€ÐµÐ· Nginx)"
fi
echo "   http://$(hostname -I | awk '{print $1}'):8080 (Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿)"
echo ""
echo "ðŸ“ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   Ð›Ð¾Ð³Ð¸:            docker-compose logs -f"
echo "   ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº:      docker-compose restart"
echo "   ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:       docker-compose down"
echo "   ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ:      git pull && docker-compose up -d --build"
echo ""
